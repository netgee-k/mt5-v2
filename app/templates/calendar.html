<!-- app/templates/calendar.html -->
{% extends "base.html" %}

{% block title %}Calendar - MT5 Trading Journal{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Trading Calendar</h1>
            <p class="text-gray-600 dark:text-gray-300">{{ month_name }} {{ year }}</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/calendar?year={{ prev_year }}&month={{ prev_month }}" 
               class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                ← Previous
            </a>
            <a href="/calendar?year={{ next_year }}&month={{ next_month }}" 
               class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                Next →
            </a>
            <a href="/calendar" 
               class="bg-blue-600 dark:bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                Today
            </a>
        </div>
    </div>
</div>

<!-- Monthly Stats -->
<div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow dark:shadow-gray-700/30 border border-gray-200 dark:border-gray-700">
        <div class="text-gray-500 dark:text-gray-400 text-sm">Month Trades</div>
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ month_stats.total_trades }}</div>
    </div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow dark:shadow-gray-700/30 border border-gray-200 dark:border-gray-700">
        <div class="text-gray-500 dark:text-gray-400 text-sm">Month Profit</div>
        <div class="text-2xl font-bold {% if month_stats.total_profit > 0 %}profit-positive text-green-600 dark:text-green-400{% else %}profit-negative text-red-600 dark:text-red-400{% endif %}">
            ${{ "%.2f"|format(month_stats.total_profit) }}
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow dark:shadow-gray-700/30 border border-gray-200 dark:border-gray-700">
        <div class="text-gray-500 dark:text-gray-400 text-sm">Month Win Rate</div>
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(month_stats.win_rate) }}%</div>
    </div>
    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow dark:shadow-gray-700/30 border border-gray-200 dark:border-gray-700">
        <div class="text-gray-500 dark:text-gray-400 text-sm">Best Day</div>
        <div class="text-2xl font-bold text-gray-900 dark:text-white">
            {% set ns = namespace(best_profit=0) %}
            {% for week in calendar %}
                {% for day in week %}
                    {% if day and day.profit > ns.best_profit %}
                        {% set ns.best_profit = day.profit %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            ${{ "%.2f"|format(ns.best_profit) }}
        </div>
    </div>
</div>

<!-- Calendar -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700/30 overflow-hidden border border-gray-200 dark:border-gray-700">
    <!-- Weekday headers -->
    <div class="grid grid-cols-7 bg-gray-100 dark:bg-gray-900 border-b dark:border-gray-700">
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Sunday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Monday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Tuesday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Wednesday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Thursday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Friday</div>
        <div class="p-4 text-center font-bold text-gray-700 dark:text-gray-300">Saturday</div>
    </div>
    
    <!-- Calendar weeks -->
    {% for week in calendar %}
    <div class="grid grid-cols-7 border-b dark:border-gray-700 last:border-b-0">
        {% for day in week %}
            {% if day %}
            <div class="min-h-32 border-r dark:border-gray-700 last:border-r-0 p-3 {% if day.is_today %}bg-blue-50 dark:bg-blue-900/20{% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold {% if day.is_today %}text-blue-600 dark:text-blue-400{% else %}text-gray-900 dark:text-white{% endif %}">
                        {{ day.day }}
                    </div>
                    {% if day.count > 0 %}
                    <span class="text-xs bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded">
                        {{ day.count }} trade{% if day.count != 1 %}s{% endif %}
                    </span>
                    {% endif %}
                </div>
                
                {% if day.count > 0 %}
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Profit:</span>
                        <span class="font-medium {% if day.profit > 0 %}profit-positive text-green-600 dark:text-green-400{% else %}profit-negative text-red-600 dark:text-red-400{% endif %}">
                            ${{ "%.2f"|format(day.profit) }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Win Rate:</span>
                        <span class="font-medium text-gray-900 dark:text-white">
                            {{ "%.0f"|format(day.win_rate) }}%
                        </span>
                    </div>
                    <div class="pt-2">
                        <a href="/trades?skip=0&limit=50&date={{ day.date.isoformat() }}" 
                           class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">
                            View trades →
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="text-gray-400 dark:text-gray-500 text-sm mt-6">
                    No trades
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="min-h-32 border-r dark:border-gray-700 last:border-r-0 p-3 bg-gray-50 dark:bg-gray-900/50"></div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- Legend -->
<div class="mt-6 flex flex-wrap items-center justify-center gap-4 md:gap-6 text-sm">
    <div class="flex items-center">
        <div class="w-4 h-4 bg-blue-50 dark:bg-blue-900/20 mr-2 border border-blue-200 dark:border-blue-800"></div>
        <span class="text-gray-600 dark:text-gray-300">Today</span>
    </div>
    <div class="flex items-center">
        <div class="w-4 h-4 bg-green-50 dark:bg-green-900/20 mr-2 border border-green-200 dark:border-green-800"></div>
        <span class="text-gray-600 dark:text-gray-300">Profitable day</span>
    </div>
    <div class="flex items-center">
        <div class="w-4 h-4 bg-red-50 dark:bg-red-900/20 mr-2 border border-red-200 dark:border-red-800"></div>
        <span class="text-gray-600 dark:text-gray-300">Loss day</span>
    </div>
</div>

<!-- Color coding based on profit -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dayCells = document.querySelectorAll('[class*="min-h-32"]:not(.bg-gray-50):not(.dark\\:bg-gray-900)');
    
    dayCells.forEach(cell => {
        const profitElement = cell.querySelector('.profit-positive, .profit-negative');
        if (profitElement) {
            const isPositive = profitElement.classList.contains('profit-positive');
            if (isPositive && !cell.classList.contains('bg-blue-50') && !cell.classList.contains('dark:bg-blue-900')) {
                cell.classList.add('bg-green-50', 'dark:bg-green-900/20');
                cell.classList.add('border-green-200', 'dark:border-green-800');
            } else if (!isPositive && !cell.classList.contains('bg-blue-50') && !cell.classList.contains('dark:bg-blue-900')) {
                cell.classList.add('bg-red-50', 'dark:bg-red-900/20');
                cell.classList.add('border-red-200', 'dark:border-red-800');
            }
        }
    });
});
</script>
{% endblock %}
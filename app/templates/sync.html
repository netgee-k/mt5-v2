<!-- app/templates/sync.html -->
{% extends "base.html" %}

{% block title %}Sync with MT5 - MT5 Trading Journal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Sync with MT5</h1>
        <p class="text-gray-600 dark:text-gray-300">Sync your trades from MetaTrader 5 terminal</p>
    </div>

    {% if message %}
    <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg text-green-800 dark:text-green-300">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            {{ message }}
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-300">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            {{ error }}
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Manual Sync Form -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700/30 p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Manual Sync</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Sync trades for a specific number of days</p>
            
            <form method="post" action="/sync">
                <div class="mb-4">
                    <label for="days" class="block text-gray-700 dark:text-gray-300 mb-2">
                        Number of days to sync:
                    </label>
                    <input type="number" 
                           id="days" 
                           name="days" 
                           value="30" 
                           min="1" 
                           max="3650"
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:focus:ring-blue-400 dark:focus:border-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        Sync trades from the last N days. Max 10 years (3650 days).
                    </p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 dark:bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-700 dark:hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors">
                    <i class="fas fa-sync mr-2"></i> Start Sync
                </button>
            </form>
        </div>

        <!-- Quick Sync Options -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700/30 p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Quick Sync</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">One-click sync options</p>
            
            <div class="space-y-4">
                <button onclick="quickSync(7)" 
                        class="w-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 py-3 px-4 rounded hover:bg-blue-200 dark:hover:bg-blue-800/40 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <i class="fas fa-sync-alt mr-2"></i> Sync Last 7 Days
                </button>
                
                <button onclick="quickSync(30)" 
                        class="w-full bg-blue-200 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 py-3 px-4 rounded hover:bg-blue-300 dark:hover:bg-blue-800/50 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <i class="fas fa-sync-alt mr-2"></i> Sync Last 30 Days
                </button>
                
                <button onclick="quickSync(90)" 
                        class="w-full bg-blue-300 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 py-3 px-4 rounded hover:bg-blue-400 dark:hover:bg-blue-800/60 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <i class="fas fa-sync-alt mr-2"></i> Sync Last 90 Days
                </button>
                
                <button onclick="quickSync(365)" 
                        class="w-full bg-green-600 dark:bg-green-500 text-white py-3 px-4 rounded hover:bg-green-700 dark:hover:bg-green-600 transition-colors focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    <i class="fas fa-history mr-2"></i> Sync All History (1 Year)
                </button>
            </div>
        </div>
    </div>

    <!-- Sync Instructions -->
    <div class="mt-8 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">
            <i class="fas fa-clipboard-list mr-2"></i> Sync Instructions
        </h3>
        <ol class="list-decimal pl-5 space-y-2 text-gray-700 dark:text-gray-300">
            <li>Ensure MetaTrader 5 terminal is running on your computer</li>
            <li>Make sure you're logged into your trading account in MT5</li>
            <li>Select the number of days to sync or use quick sync options</li>
            <li>Click "Start Sync" to begin the synchronization process</li>
            <li>Wait for the sync to complete (this may take a few moments)</li>
            <li>Once complete, you'll be redirected to the dashboard</li>
        </ol>
        
        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-sm text-blue-800 dark:text-blue-300">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Note:</strong> The sync process will import all closed trades from your MT5 account history.
            Open positions will not be synced.
        </div>
    </div>

    <!-- Database Info -->
    <div class="mt-8 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
        <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">
            <i class="fas fa-database mr-2"></i> Database Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-700">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">Current Status:</p>
                <div class="flex items-center">
                    <div id="syncStatusIcon" class="w-3 h-3 bg-yellow-500 rounded-full mr-2 animate-pulse"></div>
                    <p id="syncStatus" class="font-medium text-gray-900 dark:text-white">Loading...</p>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-700">
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">Last Sync:</p>
                <div class="flex items-center">
                    <i class="fas fa-clock text-gray-400 dark:text-gray-500 mr-2"></i>
                    <p id="lastSync" class="font-medium text-gray-900 dark:text-white">Loading...</p>
                </div>
            </div>
        </div>
        
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                <div id="totalTrades" class="text-2xl font-bold text-gray-900 dark:text-white">--</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Total Trades</div>
            </div>
            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                <div id="totalProfit" class="text-2xl font-bold text-gray-900 dark:text-white">--</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Total Profit</div>
            </div>
            <div class="text-center p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                <div id="winRate" class="text-2xl font-bold text-gray-900 dark:text-white">--</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Win Rate</div>
            </div>
        </div>
    </div>

    <!-- Recent Sync History -->
    <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700/30 border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">
            <i class="fas fa-history mr-2"></i> Recent Sync History
        </h3>
        <div id="syncHistory" class="text-gray-600 dark:text-gray-400 text-center py-8">
            Loading sync history...
        </div>
    </div>
</div>

<script>
async function quickSync(days) {
    const button = event.target;
    const originalText = button.textContent;
    const originalHTML = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
    button.disabled = true;
    
    // Disable all quick sync buttons
    document.querySelectorAll('button[onclick^="quickSync"]').forEach(btn => {
        btn.disabled = true;
    });
    
    try {
        const response = await fetch('/api/sync-mt5?days=' + days, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success notification
            showNotification('success', '✅ Sync successful!', 'Total trades in database: ' + result.total_in_db);
            
            // Reload database info
            setTimeout(() => {
                loadDatabaseInfo();
                loadSyncHistory();
            }, 1000);
            
            // Optionally redirect to dashboard
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        } else {
            showNotification('error', '❌ Sync failed', result.error || 'Unknown error');
        }
    } catch (error) {
        showNotification('error', '❌ Error', 'Error syncing trades: ' + error.message);
    } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
        
        // Re-enable all quick sync buttons
        document.querySelectorAll('button[onclick^="quickSync"]').forEach(btn => {
            btn.disabled = false;
        });
    }
}

// Show notification
function showNotification(type, title, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full ${
        type === 'success' 
            ? 'bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300'
            : 'bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300'
    }`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-3"></i>
            <div>
                <div class="font-bold">${title}</div>
                <div class="text-sm">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
        notification.classList.add('translate-x-0');
    }, 10);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// Load database info
async function loadDatabaseInfo() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        const syncStatusIcon = document.getElementById('syncStatusIcon');
        if (stats.total_trades > 0) {
            syncStatusIcon.className = 'w-3 h-3 bg-green-500 rounded-full mr-2';
            document.getElementById('syncStatus').textContent = 
                stats.total_trades + ' trades synced';
        } else {
            syncStatusIcon.className = 'w-3 h-3 bg-yellow-500 rounded-full mr-2';
            document.getElementById('syncStatus').textContent = 'No trades synced yet';
        }
        
        // Update stats boxes
        document.getElementById('totalTrades').textContent = stats.total_trades;
        document.getElementById('totalProfit').textContent = '$' + stats.total_profit.toFixed(2);
        document.getElementById('totalProfit').className = stats.total_profit > 0 
            ? 'text-2xl font-bold text-green-600 dark:text-green-400'
            : stats.total_profit < 0
                ? 'text-2xl font-bold text-red-600 dark:text-red-400'
                : 'text-2xl font-bold text-gray-900 dark:text-white';
        
        document.getElementById('winRate').textContent = stats.win_rate.toFixed(1) + '%';
        
        // Try to get last sync time from recent trades
        if (stats.total_trades > 0) {
            try {
                const tradesResponse = await fetch('/api/trades?limit=1');
                const trades = await tradesResponse.json();
                if (trades.length > 0) {
                    const lastTradeDate = new Date(trades[0].time);
                    const now = new Date();
                    const diffMs = now - lastTradeDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    let timeText;
                    if (diffMins < 60) {
                        timeText = `${diffMins} minutes ago`;
                    } else if (diffHours < 24) {
                        timeText = `${diffHours} hours ago`;
                    } else {
                        timeText = `${diffDays} days ago`;
                    }
                    
                    document.getElementById('lastSync').textContent = 
                        lastTradeDate.toLocaleDateString() + ` (${timeText})`;
                }
            } catch (error) {
                document.getElementById('lastSync').textContent = 'Recent';
            }
        } else {
            document.getElementById('lastSync').textContent = 'Never synced';
        }
    } catch (error) {
        console.error('Error loading database info:', error);
        document.getElementById('syncStatus').textContent = 'Error loading info';
        document.getElementById('lastSync').textContent = 'N/A';
    }
}

// Load sync history
async function loadSyncHistory() {
    try {
        // This would need a proper API endpoint for sync history
        // For now, we'll just show a placeholder
        const response = await fetch('/api/trades?limit=5');
        const recentTrades = await response.json();
        
        const historyDiv = document.getElementById('syncHistory');
        
        if (recentTrades.length === 0) {
            historyDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No sync history available</p>';
            return;
        }
        
        let historyHTML = '<div class="space-y-3">';
        
        // Group trades by day for sync history display
        const groupedByDay = {};
        recentTrades.forEach(trade => {
            const date = new Date(trade.time).toLocaleDateString();
            if (!groupedByDay[date]) {
                groupedByDay[date] = {
                    count: 0,
                    profit: 0
                };
            }
            groupedByDay[date].count++;
            groupedByDay[date].profit += trade.profit;
        });
        
        // Show last 5 sync days
        const syncDays = Object.entries(groupedByDay).slice(0, 5);
        
        if (syncDays.length === 0) {
            historyHTML += '<p class="text-gray-500 dark:text-gray-400">No sync history available</p>';
        } else {
            syncDays.forEach(([date, data]) => {
                historyHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-day text-gray-400 dark:text-gray-500 mr-3"></i>
                            <div>
                                <div class="font-medium text-gray-900 dark:text-white">${date}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${data.count} trades</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium ${data.profit > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                $${data.profit.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        historyHTML += '</div>';
        historyDiv.innerHTML = historyHTML;
        
    } catch (error) {
        console.error('Error loading sync history:', error);
        document.getElementById('syncHistory').innerHTML = 
            '<p class="text-red-500 dark:text-red-400">Error loading sync history</p>';
    }
}

// Load database info when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseInfo();
    loadSyncHistory();
    
    // Check if MT5 credentials are set
    fetch('/api/check-mt5-credentials')
        .then(response => response.json())
        .then(data => {
            if (!data.credentials_set) {
                showNotification('warning', '⚠️ MT5 Credentials Required', 
                    'Please set up your MT5 credentials in Settings before syncing.');
            }
        })
        .catch(() => {
            // Silently fail - not critical
        });
});
</script>
{% endblock %}
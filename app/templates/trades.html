<!-- app/templates/trades.html -->
{% extends "base.html" %}

{% block title %}All Trades - MT5 Trading Journal{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">All Trades</h1>
    <p class="text-gray-600">Browse and filter your trading history</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="symbolFilter" class="block text-gray-700 mb-2">Filter by Symbol:</label>
            <div class="flex space-x-2">
                <select id="symbolFilter" class="flex-grow p-2 border border-gray-300 rounded">
                    <option value="">All Symbols</option>
                    {% for symbol in symbols %}
                    <option value="{{ symbol }}" {% if current_symbol == symbol %}selected{% endif %}>{{ symbol }}</option>
                    {% endfor %}
                </select>
                <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Filter
                </button>
            </div>
        </div>
        
        <div>
            <label class="block text-gray-700 mb-2">Trade Type:</label>
            <div class="flex space-x-2">
                <button onclick="filterByType('')" class="px-4 py-2 border rounded hover:bg-gray-100 {% if not request.query_params.get('type') %}bg-gray-200{% endif %}">
                    All
                </button>
                <button onclick="filterByType('BUY')" class="px-4 py-2 border rounded hover:bg-blue-50 {% if request.query_params.get('type') == 'BUY' %}bg-blue-100{% endif %}">
                    BUY
                </button>
                <button onclick="filterByType('SELL')" class="px-4 py-2 border rounded hover:bg-purple-50 {% if request.query_params.get('type') == 'SELL' %}bg-purple-100{% endif %}">
                    SELL
                </button>
            </div>
        </div>
        
        <div>
            <label class="block text-gray-700 mb-2">Result:</label>
            <div class="flex space-x-2">
                <button onclick="filterByResult('')" class="px-4 py-2 border rounded hover:bg-gray-100 {% if not request.query_params.get('win') %}bg-gray-200{% endif %}">
                    All
                </button>
                <button onclick="filterByResult('win')" class="px-4 py-2 border rounded hover:bg-green-50 {% if request.query_params.get('win') == 'true' %}bg-green-100{% endif %}">
                    Win
                </button>
                <button onclick="filterByResult('loss')" class="px-4 py-2 border rounded hover:bg-red-50 {% if request.query_params.get('win') == 'false' %}bg-red-100{% endif %}">
                    Loss
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Trades Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-6 border-b flex justify-between items-center">
        <h2 class="text-xl font-bold">Trades List</h2>
        <div class="text-gray-600">
            Showing {{ trades|length }} of {{ total_trades }} trades
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Ticket</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Time</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Symbol</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Type</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Volume</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Price</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">SL/TP</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Profit</th>
                    <th class="py-3 px-6 text-left text-gray-600 font-medium">Result</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr class="border-t hover:bg-gray-50">
                    <td class="py-4 px-6">#{{ trade.ticket }}</td>
                    <td class="py-4 px-6">
                        <div>{{ trade.time.strftime('%Y-%m-%d') }}</div>
                        <div class="text-sm text-gray-500">{{ trade.time.strftime('%H:%M:%S') }}</div>
                    </td>
                    <td class="py-4 px-6 font-medium">{{ trade.symbol }}</td>
                    <td class="py-4 px-6">
                        <span class="px-2 py-1 rounded text-xs {% if trade.type == 'BUY' %}bg-blue-100 text-blue-800{% else %}bg-purple-100 text-purple-800{% endif %}">
                            {{ trade.type }}
                        </span>
                    </td>
                    <td class="py-4 px-6">{{ trade.volume }}</td>
                    <td class="py-4 px-6">${{ "%.5f"|format(trade.price) }}</td>
                    <td class="py-4 px-6">
                        <div class="text-sm">
                            <div>SL: ${{ "%.5f"|format(trade.sl) if trade.sl else 'N/A' }}</div>
                            <div>TP: ${{ "%.5f"|format(trade.tp) if trade.tp else 'N/A' }}</div>
                        </div>
                    </td>
                    <td class="py-4 px-6 font-bold {% if trade.profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                        ${{ "%.2f"|format(trade.profit) }}
                    </td>
                    <td class="py-4 px-6">
                        {% if trade.win %}
                        <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">WIN</span>
                        {% else %}
                        <span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800">LOSS</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="py-8 px-6 text-center text-gray-500">
                        No trades found. 
                        <a href="/sync" class="text-blue-600 hover:text-blue-800">Sync with MT5</a> to get started.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if total_trades > 0 %}
    <div class="p-6 border-t flex justify-between items-center">
        <div class="text-gray-600">
            Page {{ (skip // limit) + 1 }} of {{ (total_trades // limit) + 1 }}
        </div>
        <div class="flex space-x-2">
            {% if skip > 0 %}
            <a href="/trades?skip={{ skip - limit }}&limit={{ limit }}{% if current_symbol %}&symbol={{ current_symbol }}{% endif %}" 
               class="px-4 py-2 border rounded hover:bg-gray-100">
                ← Previous
            </a>
            {% endif %}
            
            {% if skip + limit < total_trades %}
            <a href="/trades?skip={{ skip + limit }}&limit={{ limit }}{% if current_symbol %}&symbol={{ current_symbol }}{% endif %}" 
               class="px-4 py-2 border rounded hover:bg-gray-100">
                Next →
            </a>
            {% endif %}
        </div>
        
        <div class="flex items-center space-x-2">
            <span class="text-gray-600">Show:</span>
            <select onchange="changeLimit(this.value)" class="p-2 border rounded">
                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
            </select>
            <span class="text-gray-600">trades per page</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Export Section -->
<div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
    <h3 class="text-lg font-bold mb-4">Export Data</h3>
    <p class="mb-4 text-gray-600">Export your trading data for analysis in other tools:</p>
    <div class="flex space-x-4">
        <button onclick="exportData('csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Export as CSV
        </button>
        <button onclick="exportData('json')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Export as JSON
        </button>
    </div>
</div>

<script>
function applyFilters() {
    const symbol = document.getElementById('symbolFilter').value;
    let url = '/trades?skip=0&limit={{ limit }}';
    if (symbol) {
        url += '&symbol=' + encodeURIComponent(symbol);
    }
    window.location.href = url;
}

function filterByType(type) {
    let url = '/trades?skip=0&limit={{ limit }}';
    {% if current_symbol %}url += '&symbol={{ current_symbol }}';{% endif %}
    if (type) {
        url += '&type=' + type;
    }
    window.location.href = url;
}

function filterByResult(result) {
    let url = '/trades?skip=0&limit={{ limit }}';
    {% if current_symbol %}url += '&symbol={{ current_symbol }}';{% endif %}
    if (result === 'win') {
        url += '&win=true';
    } else if (result === 'loss') {
        url += '&win=false';
    }
    window.location.href = url;
}

function changeLimit(newLimit) {
    let url = '/trades?skip=0&limit=' + newLimit;
    {% if current_symbol %}url += '&symbol={{ current_symbol }}';{% endif %}
    window.location.href = url;
}

async function exportData(format) {
    try {
        const response = await fetch('/api/trades?limit=10000');
        const trades = await response.json();
        
        if (format === 'csv') {
            exportToCSV(trades);
        } else if (format === 'json') {
            exportToJSON(trades);
        }
    } catch (error) {
        alert('Error exporting data: ' + error.message);
    }
}

function exportToCSV(trades) {
    if (trades.length === 0) {
        alert('No trades to export');
        return;
    }
    
    // Create CSV header
    const headers = ['Ticket', 'Time', 'Symbol', 'Type', 'Volume', 'Price', 'SL', 'TP', 'Profit', 'Win'];
    const csvRows = [headers.join(',')];
    
    // Add data rows
    trades.forEach(trade => {
        const row = [
            trade.ticket,
            trade.time,
            trade.symbol,
            trade.type,
            trade.volume,
            trade.price,
            trade.sl || '',
            trade.tp || '',
            trade.profit,
            trade.win ? 'Yes' : 'No'
        ];
        csvRows.push(row.join(','));
    });
    
    // Create and download file
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'mt5-trades-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function exportToJSON(trades) {
    if (trades.length === 0) {
        alert('No trades to export');
        return;
    }
    
    const jsonContent = JSON.stringify(trades, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'mt5-trades-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}